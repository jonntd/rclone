# STRM-Mount QPS å®‰å…¨éƒ¨ç½²æŒ‡å—

## ğŸ¯ **æ¦‚è¿°**

æœ¬æŒ‡å—æä¾›å®Œæ•´çš„ STRM-Mount + Emby éƒ¨ç½²æ–¹æ¡ˆï¼Œç¡®ä¿ä¸è§¦å‘ç½‘ç›˜ QPS é™åˆ¶ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

---

## âš ï¸ **é£é™©è¯„ä¼°**

### **QPS é™åˆ¶å¯¹æ¯”**
| ç½‘ç›˜ | ä¼°è®¡QPSé™åˆ¶ | é£é™©ç­‰çº§ | æ¨èç­–ç•¥ |
|------|-------------|----------|----------|
| **123ç½‘ç›˜** | 10-20/ç§’ | ğŸ”´ é«˜é£é™© | æä¿å®ˆé…ç½® |
| **115ç½‘ç›˜** | 20-50/ç§’ | ğŸŸ¡ ä¸­é£é™© | ä¿å®ˆé…ç½® |
| **å…¶ä»–ç½‘ç›˜** | æœªçŸ¥ | ğŸ”´ é«˜é£é™© | æœ€ä¿å®ˆé…ç½® |

### **é£é™©åœºæ™¯**
- âœ… **ä½é£é™©**: <100ä¸ªæ–‡ä»¶ï¼Œæ‰‹åŠ¨æ‰«æï¼Œå•ç”¨æˆ·
- âš ï¸ **ä¸­é£é™©**: 100-1000ä¸ªæ–‡ä»¶ï¼Œå®šæ—¶æ‰«æï¼Œå°‘é‡ç”¨æˆ·
- ğŸ”´ **é«˜é£é™©**: >1000ä¸ªæ–‡ä»¶ï¼Œå®æ—¶ç›‘æ§ï¼Œå¤šç”¨æˆ·å¹¶å‘

---

## ğŸš€ **å¿«é€Ÿéƒ¨ç½²**

### **æ­¥éª¤1: ä½¿ç”¨ QPS å®‰å…¨å¯åŠ¨è„šæœ¬**

```bash
# 123ç½‘ç›˜ç¤ºä¾‹
./scripts/strm-mount-qps-safe.sh 123 Movies /mnt/123-movies 50M

# 115ç½‘ç›˜ç¤ºä¾‹  
./scripts/strm-mount-qps-safe.sh 115 /ç”µå½± /mnt/115-movies 100M
```

### **æ­¥éª¤2: åº”ç”¨ Emby ä¼˜åŒ–é…ç½®**

```bash
# å¤‡ä»½ç°æœ‰é…ç½®
cp /path/to/emby/config.json /path/to/emby/config.json.backup

# åº”ç”¨ä¼˜åŒ–é…ç½®
cp configs/emby-strm-optimized.json /path/to/emby/config.json

# é‡å¯ Emby æœåŠ¡
systemctl restart emby-server
```

### **æ­¥éª¤3: å¯åŠ¨ QPS ç›‘æ§**

```bash
# å¯åŠ¨å®æ—¶ç›‘æ§
./scripts/monitor-qps.sh

# åå°ç›‘æ§
nohup ./scripts/monitor-qps.sh > /tmp/qps-monitor.log 2>&1 &
```

---

## ğŸ”§ **è¯¦ç»†é…ç½®**

### **STRM-Mount å‚æ•°ä¼˜åŒ–**

#### **123ç½‘ç›˜ (æä¿å®ˆé…ç½®)**
```bash
rclone strm-mount 123:Movies /mnt/strm \
  --persistent-cache=true \
  --cache-ttl=3h \              # 3å°æ—¶ç¼“å­˜
  --min-size=50M \              # 50MBæœ€å°æ–‡ä»¶
  --checkers=1 \                # å•çº¿ç¨‹æ£€æŸ¥
  --transfers=1 \               # å•çº¿ç¨‹ä¼ è¾“
  --vfs-cache-mode=minimal \    # æœ€å°ç¼“å­˜
  --buffer-size=0 \             # æ— ç¼“å†²
  --vfs-read-ahead=0 \          # æ— é¢„è¯»
  --log-level=INFO \
  --daemon
```

#### **115ç½‘ç›˜ (ä¿å®ˆé…ç½®)**
```bash
rclone strm-mount 115:Videos /mnt/strm \
  --persistent-cache=true \
  --cache-ttl=2h \              # 2å°æ—¶ç¼“å­˜
  --min-size=100M \             # 100MBæœ€å°æ–‡ä»¶
  --checkers=2 \                # åŒçº¿ç¨‹æ£€æŸ¥
  --transfers=1 \               # å•çº¿ç¨‹ä¼ è¾“
  --vfs-cache-mode=minimal \
  --buffer-size=0 \
  --vfs-read-ahead=0 \
  --log-level=INFO \
  --daemon
```

### **Emby å…³é”®é…ç½®**

#### **å¿…é¡»ç¦ç”¨çš„åŠŸèƒ½**
```json
{
  "EnableRealtimeMonitor": false,           // ğŸ”´ å…³é”®ï¼šç¦ç”¨å®æ—¶ç›‘æ§
  "EnableChapterImageExtraction": false,    // ç¦ç”¨ç« èŠ‚å›¾åƒ
  "EnableTrickplayImageExtraction": false,  // ç¦ç”¨é¢„è§ˆå›¾
  "EnablePeriodicScanning": false,          // ç¦ç”¨å®šæœŸæ‰«æ
  "ScanOnStartup": false                    // ç¦ç”¨å¯åŠ¨æ‰«æ
}
```

#### **æ‰«æç­–ç•¥ä¼˜åŒ–**
```json
{
  "ScheduledTasks": {
    "LibraryScan": {
      "IntervalHours": 24,                  // 24å°æ—¶æ‰«æä¸€æ¬¡
      "MaxConcurrentScans": 1               // é™åˆ¶å¹¶å‘æ‰«æ
    }
  }
}
```

---

## ğŸ“Š **ç›‘æ§å’Œå‘Šè­¦**

### **QPS ç›‘æ§æŒ‡æ ‡**

| æŒ‡æ ‡ | å®‰å…¨é˜ˆå€¼ | è­¦å‘Šé˜ˆå€¼ | å±é™©é˜ˆå€¼ |
|------|----------|----------|----------|
| **1åˆ†é’ŸQPS** | <3 | 3-5 | >5 |
| **5åˆ†é’Ÿå¹³å‡QPS** | <2 | 2-4 | >4 |
| **ç¼“å­˜å‘½ä¸­ç‡** | >90% | 80-90% | <80% |

### **ç›‘æ§å‘½ä»¤**

```bash
# å®æ—¶ç›‘æ§é¢æ¿
./scripts/monitor-qps.sh

# æ£€æŸ¥ API è°ƒç”¨é¢‘ç‡
grep -E "\[API\]|\[SYNC\]" /tmp/strm-mount-qps-safe.log | tail -20

# æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
grep -E "(Hit|Miss)" /tmp/strm-mount-qps-safe.log | tail -20

# æ£€æŸ¥é”™è¯¯æ—¥å¿—
grep -E "(ERROR|CRITICAL)" /tmp/strm-mount-qps-safe.log | tail -10
```

### **å‘Šè­¦è„šæœ¬**

```bash
#!/bin/bash
# qps-alert.sh - QPS å‘Šè­¦è„šæœ¬

QPS_THRESHOLD=5
LOG_FILE="/tmp/strm-mount-qps-safe.log"

# è®¡ç®—æœ€è¿‘1åˆ†é’Ÿçš„ QPS
recent_qps=$(grep -E "\[API\]|\[SYNC\]" "$LOG_FILE" | \
  tail -60 | wc -l)

if [[ $recent_qps -gt $QPS_THRESHOLD ]]; then
    echo "ğŸš¨ QPS å‘Šè­¦: å½“å‰ QPS = $recent_qps (é˜ˆå€¼: $QPS_THRESHOLD)"
    # å‘é€é‚®ä»¶/çŸ­ä¿¡/Webhook é€šçŸ¥
    # curl -X POST "https://your-webhook-url" -d "QPS Alert: $recent_qps"
fi
```

---

## ğŸ›¡ï¸ **åº”æ€¥å¤„ç†**

### **QPS é™åˆ¶è§¦å‘æ—¶çš„å¤„ç†æ­¥éª¤**

#### **ç«‹å³å“åº” (5åˆ†é’Ÿå†…)**
```bash
# 1. åœæ­¢ Emby æ‰«æ
systemctl stop emby-server

# 2. åœæ­¢ STRM-Mount
./scripts/unmount-strm.sh -f

# 3. æ£€æŸ¥ç½‘ç›˜è´¦æˆ·çŠ¶æ€
rclone ls 123:Movies --max-depth 1  # æµ‹è¯•æ˜¯å¦è¢«é™åˆ¶
```

#### **çŸ­æœŸç¼“è§£ (1å°æ—¶å†…)**
```bash
# 1. å¢åŠ ç¼“å­˜æ—¶é—´
--cache-ttl=6h  # å¢åŠ åˆ°6å°æ—¶

# 2. å‡å°‘å¹¶å‘
--checkers=1 --transfers=1

# 3. é‡æ–°å¯åŠ¨ï¼ˆä¿å®ˆæ¨¡å¼ï¼‰
./scripts/strm-mount-qps-safe.sh 123 Movies /mnt/strm 100M
```

#### **é•¿æœŸä¼˜åŒ– (24å°æ—¶å†…)**
```bash
# 1. åˆ†æè®¿é—®æ¨¡å¼
grep -E "\[API\]" /tmp/strm-mount-qps-safe.log | \
  awk '{print $1, $2}' | sort | uniq -c

# 2. ä¼˜åŒ–æ–‡ä»¶ç»“æ„
# å°†å¤§é‡å°æ–‡ä»¶åˆå¹¶åˆ°å­ç›®å½•

# 3. å®æ–½åˆ†æ‰¹æ‰«æ
# åˆ†æ—¶æ®µæ‰«æä¸åŒçš„åª’ä½“åº“
```

---

## ğŸ“ˆ **æ€§èƒ½ä¼˜åŒ–**

### **ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**

#### **å°å‹åª’ä½“åº“ (<100ä¸ªæ–‡ä»¶)**
```bash
--cache-ttl=1h          # 1å°æ—¶ç¼“å­˜
--min-size=10M          # 10MBæœ€å°æ–‡ä»¶
```

#### **ä¸­å‹åª’ä½“åº“ (100-1000ä¸ªæ–‡ä»¶)**
```bash
--cache-ttl=3h          # 3å°æ—¶ç¼“å­˜
--min-size=50M          # 50MBæœ€å°æ–‡ä»¶
```

#### **å¤§å‹åª’ä½“åº“ (>1000ä¸ªæ–‡ä»¶)**
```bash
--cache-ttl=6h          # 6å°æ—¶ç¼“å­˜
--min-size=100M         # 100MBæœ€å°æ–‡ä»¶
```

### **Emby æ‰«æç­–ç•¥**

#### **åˆ†æ—¶æ®µæ‰«æ**
```bash
# å‡Œæ™¨2ç‚¹æ‰«æç”µå½±
0 2 * * * /usr/bin/emby-scan-library "Movies"

# å‡Œæ™¨3ç‚¹æ‰«æç”µè§†å‰§
0 3 * * * /usr/bin/emby-scan-library "TV Shows"

# å‡Œæ™¨4ç‚¹æ‰«æåŠ¨æ¼«
0 4 * * * /usr/bin/emby-scan-library "Anime"
```

#### **å¢é‡æ‰«æ**
```bash
# åªæ‰«ææ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶
emby-scan-library --incremental "Movies"
```

---

## ğŸ” **æ•…éšœæ’é™¤**

### **å¸¸è§é—®é¢˜**

#### **1. QPS é™åˆ¶è§¦å‘**
**ç—‡çŠ¶**: API è°ƒç”¨è¿”å› 429 é”™è¯¯æˆ–è¯·æ±‚è¶…æ—¶
**è§£å†³**:
```bash
# æ£€æŸ¥å½“å‰ QPS
./scripts/monitor-qps.sh

# å¢åŠ ç¼“å­˜æ—¶é—´
--cache-ttl=12h

# ç­‰å¾…é™åˆ¶è§£é™¤ (é€šå¸¸1-24å°æ—¶)
```

#### **2. ç¼“å­˜å‘½ä¸­ç‡ä½**
**ç—‡çŠ¶**: å¤§é‡ API è°ƒç”¨ï¼Œå“åº”ç¼“æ…¢
**è§£å†³**:
```bash
# æ£€æŸ¥ç¼“å­˜é…ç½®
grep "cache-ttl" /tmp/strm-mount-qps-safe.log

# å¢åŠ ç¼“å­˜æ—¶é—´
--cache-ttl=6h

# æ£€æŸ¥æ–‡ä»¶è®¿é—®æ¨¡å¼
grep "Hit\|Miss" /tmp/strm-mount-qps-safe.log | tail -50
```

#### **3. Emby æ‰«æè¿‡äºé¢‘ç¹**
**ç—‡çŠ¶**: æŒç»­çš„é«˜ QPS
**è§£å†³**:
```bash
# æ£€æŸ¥ Emby æ‰«ææ—¥å¿—
tail -f /var/log/emby/emby.log | grep -i scan

# ç¦ç”¨å®æ—¶ç›‘æ§
"EnableRealtimeMonitor": false

# å¢åŠ æ‰«æé—´éš”
"IntervalHours": 48
```

---

## ğŸ“‹ **éƒ¨ç½²æ£€æŸ¥æ¸…å•**

### **éƒ¨ç½²å‰æ£€æŸ¥**
- [ ] ç½‘ç›˜é…ç½®æ­£ç¡® (`rclone config show`)
- [ ] æŒ‚è½½ç‚¹ç›®å½•å­˜åœ¨ä¸”å¯å†™
- [ ] é˜²ç«å¢™å…è®¸ç›¸å…³ç«¯å£
- [ ] ç£ç›˜ç©ºé—´å……è¶³ (ç¼“å­˜æ–‡ä»¶)

### **é…ç½®æ£€æŸ¥**
- [ ] STRM-Mount ä½¿ç”¨ QPS å®‰å…¨å‚æ•°
- [ ] Emby ç¦ç”¨å®æ—¶ç›‘æ§
- [ ] Emby ç¦ç”¨ç¼©ç•¥å›¾ç”Ÿæˆ
- [ ] æ‰«æé—´éš”è®¾ç½®ä¸º24å°æ—¶ä»¥ä¸Š
- [ ] å¯ç”¨æŒä¹…åŒ–ç¼“å­˜

### **ç›‘æ§æ£€æŸ¥**
- [ ] QPS ç›‘æ§è„šæœ¬è¿è¡Œæ­£å¸¸
- [ ] æ—¥å¿—æ–‡ä»¶æ­£ç¡®ç”Ÿæˆ
- [ ] å‘Šè­¦æœºåˆ¶é…ç½®å®Œæˆ
- [ ] ç¼“å­˜å‘½ä¸­ç‡ >80%

### **æµ‹è¯•æ£€æŸ¥**
- [ ] å°è§„æ¨¡æµ‹è¯• (<10ä¸ªæ–‡ä»¶)
- [ ] ç›‘æ§ QPS å˜åŒ–
- [ ] éªŒè¯ Emby æ‰«ææ­£å¸¸
- [ ] éªŒè¯è§†é¢‘æ’­æ”¾æ­£å¸¸

---

## ğŸ¯ **æœ€ä½³å®è·µæ€»ç»“**

### **é…ç½®åŸåˆ™**
1. **ä¿å®ˆä¼˜å…ˆ**: å®å¯æ€§èƒ½å·®ä¸€ç‚¹ï¼Œä¹Ÿä¸è¦è§¦å‘é™åˆ¶
2. **ç›‘æ§ä¸ºç‹**: å®æ—¶ç›‘æ§ QPSï¼ŒåŠæ—¶å‘ç°é—®é¢˜
3. **åˆ†é˜¶æ®µéƒ¨ç½²**: ä»å°è§„æ¨¡å¼€å§‹ï¼Œé€æ­¥æ‰©å¤§
4. **åº”æ€¥é¢„æ¡ˆ**: å‡†å¤‡å¥½åº”æ€¥å¤„ç†æµç¨‹

### **è¿ç»´å»ºè®®**
1. **å®šæœŸæ£€æŸ¥**: æ¯å‘¨æ£€æŸ¥ QPS è¶‹åŠ¿
2. **é…ç½®è°ƒä¼˜**: æ ¹æ®ä½¿ç”¨æƒ…å†µè°ƒæ•´å‚æ•°
3. **æ—¥å¿—åˆ†æ**: å®šæœŸåˆ†æè®¿é—®æ¨¡å¼
4. **å¤‡ä»½é…ç½®**: ä¿å­˜å·¥ä½œæ­£å¸¸çš„é…ç½®

### **æ€§èƒ½å¹³è¡¡**
- **é«˜æ€§èƒ½**: çŸ­ç¼“å­˜æ—¶é—´ï¼Œå¿«é€Ÿæ›´æ–°ï¼Œé«˜ QPS é£é™©
- **é«˜å®‰å…¨**: é•¿ç¼“å­˜æ—¶é—´ï¼Œæ…¢é€Ÿæ›´æ–°ï¼Œä½ QPS é£é™©
- **æ¨è**: ä¸­ç­‰ç¼“å­˜æ—¶é—´ (2-3å°æ—¶)ï¼Œå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨

**éµå¾ªæœ¬æŒ‡å—å¯ä»¥æœ€å¤§ç¨‹åº¦é¿å… QPS é™åˆ¶ï¼Œç¡®ä¿ STRM-Mount ç¨³å®šè¿è¡Œï¼** ğŸ‰
